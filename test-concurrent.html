<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
</head>
<body>
    <p id="message"></p>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <script>
        const $message = document.querySelector('#message')
        function renderMessage(msg) {
            $message.textContent = msg
        }
        // renderMessage('Probando la funciÃ³n renderMessage')

        let adList = []

        const go = async () => {
            console.time("go")
            adList = await getAdsList()
            renderMessage(`Total length of ads is ${adList.length}`)
            console.log(adList)
            console.timeEnd("go")
        }

        const requestPage = async(url) => {
            const proxy = "https://cors-anywhere.herokuapp.com/";
            return axios.get(proxy + url).catch( err => {
                console.log("Uguuu... error", err)
            })
        }

        const getAdsList = async() => {
            console.time("lbc")

            let url = "https://localbitcoins.com/sell-bitcoins-online/ves/.json"
            let urls = []
            let records = []

            for (let page = 1; page <= 10; page++) {
                urls[page-1] = requestPage(url + "?page=" + page)
            }
            // console.log(urls)
            await Promise.all(urls).then(responseArr => {
                console.timeEnd("lbc")
                // console.log("responseArr:", responseArr)

                responseArr.forEach(resp => {
                    console.log(resp)
                    if (resp && resp.data) {
                        records.push.apply(records, resp.data.data.ad_list)
                    }
                });
            })
            return records
        }

        go()
        // getAdsList()


        // const requestPage = function (url) {
        //     const proxy = "https://cors-anywhere.herokuapp.com/";
        //     return new Promise((resolve, reject) => {
        //         fetch(proxy + url)
        //         .then(response => {
        //             resolve(response);
        //         })
        //         .catch(error => {
        //             console.error(error);
        //             reject(error);
        //         });
        //     });
        // }

        // let url = "https://localbitcoins.com/sell-bitcoins-online/ves/.json";
        // var i = 1
        // requestPage(url)
        //     .then(response => response.json())
        //     .then(response => {
        //         console.log("request "+i, response); i++;
        //         let msg = response.data.ad_list.map(ad => ad.data.bank_name)
        //             .sort().join('\n')
        //         renderMessage(msg)
        //         console.log("next link:", response.pagination.next)
        //     })
        //     .catch(e => console.error(e));
    </script>
</body>
</html>